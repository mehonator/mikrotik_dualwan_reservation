# mikrotik_dualwan_reservation
Это набор скриптов для переключение на второго резервного провайдера связи. Предназначен для работы через dhcp клиентов.
This is a set of scripts for switching to a second backup communication provider. Designed to work through DHCP clients.

Скрипты протестированы на ros 7.11.2

На более ранних версиях ros, для корректного пинга с соответствующих интерфейсов возможно потребуется создать дополнительные таблицы маршрутизации, скрипты в dhcp клиентах для создания маршрутов в этих таблицах и правила mangle. Примеры есть в utils


# Принцип работы
Скрипт проверят связь через icmp запросы с серверами указанными в set_global_varible.

Если главный провайдер работает, то скрипт прекращает свою работу

Если нет связи через главного провайдера, происходит попытка обновить ip адрес в DHCP клиенте

Если нет снова связи, то идёт аналогичная проверка запасного провайдера.

Возможна перезагрузка usb модема через сброс питания, если после обновления ip адреса связи не будет, по умолчанию isResetUsb  == true

При наличии связи, переключение на запасного провайдера осуществляется простой заменой distance в dhcp клиентах. В основном устанавливается 2, у запасного 1.

Далее скрипт востанавливает обратно эти значения, если связь появляется у основного провайдера

# Установка
1. Перенести на роутер скрипты 
    1. set_global_varible
    2. functions_for_reserv
    3. test_functions_for_reserv
    4. schedule_check_and_switch_internet
    
2. В скрипте set_global_varible укажите необходимые значения
3. Желательно провести тестирование функций из файла functions_for_reserv, чтобы найти и исправить ошибки конфигурации.
ВНИМАНИЕ! Тестах симулируется отключение интернета блокировкой исходящих icmp пакетов, происходит реальный сброс питания USB, а также функции действительно меняют значения distance в dhcp клиентах. В конце для главного и запасного интерфейса значения устанавливаются distance в dhcp клиентах как 1 и 2, так как предполагается, что это значение по умолчанию.
Выше перечисленное, может привести к перебоям в связи.
4. Создать расписание schedule c названием, например "check_and_switch_internet" и в его значении сохранить:
/system/script/run schedule_check_and_switch_internet
Частоту выполнения установить по своему желанию. У меня корректно работает с 2 минутами